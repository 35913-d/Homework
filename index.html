<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แอปบันทึกรายรับรายจ่าย</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- Google Fonts: Prompt -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        /* Custom Styles */
        :root {
            --primary-color: #fce6e8; /* Light Pink */
            --secondary-color: #d1f7e0; /* Light Green */
            --text-color: #333;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
        }

        body {
            font-family: 'Prompt', sans-serif;
            background-color: #fdfcff;
            color: var(--text-color);
        }

        /* Login/Register Page Styles */
        #auth-container {
            max-width: 450px;
            margin: 5rem auto;
            padding: 2rem;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }

        .nav-pills .nav-link {
            color: var(--text-color);
            border-radius: 8px;
        }

        .nav-pills .nav-link.active {
            background-color: var(--primary-color) !important;
            color: var(--danger-color) !important;
            font-weight: 500;
        }

        .form-control {
            border-radius: 8px;
            padding: 0.75rem;
        }

        .btn-primary-custom {
            background-color: var(--success-color);
            border-color: var(--success-color);
            color: white;
            font-weight: 500;
            padding: 0.75rem;
            border-radius: 8px;
            transition: background-color: 0.3s ease;
        }

        .btn-primary-custom:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }

        /* Main App Styles */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
        }
        
        .summary-card {
            padding: 1.5rem;
            border-radius: 15px;
            color: white;
            margin-bottom: 1rem;
        }
        .income-card { background-color: var(--success-color); }
        .expense-card { background-color: var(--danger-color); }
        .balance-card { background-color: #007bff; }
        .today-expense-card { background-color: var(--warning-color); }

        .form-card, .chart-card {
            background-color: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        .transaction-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid #eee;
            border-radius: 10px;
            margin-bottom: 0.75rem;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .transaction-list-item.income { border-left: 5px solid var(--success-color); }
        .transaction-list-item.expense { border-left: 5px solid var(--danger-color); }

        .loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1050;
        }
        
        .modal-content {
            border-radius: 15px;
        }
    </style>
</head>
<body>

    <!-- Loading Spinner -->
    <div id="loading-view">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Login & Register View -->
    <div id="auth-container" style="display: none;">
        <h2 class="text-center mb-4">Expense Tracker</h2>
        <ul class="nav nav-pills nav-fill mb-4" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pills-login-tab" data-bs-toggle="pill" data-bs-target="#pills-login" type="button" role="tab" aria-controls="pills-login" aria-selected="true">เข้าสู่ระบบ</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-register-tab" data-bs-toggle="pill" data-bs-target="#pills-register" type="button" role="tab" aria-controls="pills-register" aria-selected="false">สมัครสมาชิก</button>
            </li>
        </ul>
        <div class="tab-content" id="pills-tabContent">
            <!-- Login Form -->
            <div class="tab-pane fade show active" id="pills-login" role="tabpanel" aria-labelledby="pills-login-tab">
                <form id="login-form">
                    <div class="mb-3">
                        <label for="login-email" class="form-label">อีเมล</label>
                        <input type="email" class="form-control" id="login-email" required>
                    </div>
                    <div class="mb-3">
                        <label for="login-password" class="form-label">รหัสผ่าน</label>
                        <input type="password" class="form-control" id="login-password" required>
                    </div>
                    <button type="submit" class="btn btn-primary-custom w-100">เข้าสู่ระบบ</button>
                </form>
            </div>
            <!-- Register Form -->
            <div class="tab-pane fade" id="pills-register" role="tabpanel" aria-labelledby="pills-register-tab">
                <form id="register-form">
                    <div class="mb-3">
                        <label for="register-email" class="form-label">อีเมล</label>
                        <input type="email" class="form-control" id="register-email" required>
                    </div>
                    <div class="mb-3">
                        <label for="register-password" class="form-label">รหัสผ่าน (อย่างน้อย 6 ตัวอักษร)</label>
                        <input type="password" class="form-control" id="register-password" required minlength="6">
                    </div>
                    <button type="submit" class="btn btn-primary-custom w-100">สมัครสมาชิก</button>
                </form>
            </div>
        </div>
        <div id="auth-error" class="alert alert-danger mt-3" style="display: none;"></div>
    </div>

    <!-- Main App View -->
    <div id="app-container" class="container py-4" style="display: none;">
        <header class="header text-center text-dark d-flex justify-content-between align-items-center">
            <div>
                 <h1 class="h4 mb-0">บันทึกรายรับ-รายจ่าย</h1>
                 <p id="user-email" class="mb-0 small"></p>
            </div>
            <button id="logout-btn" class="btn btn-danger">ออกจากระบบ</button>
        </header>

        <!-- Summary Section -->
        <section class="mb-4">
            <div class="row">
                <div class="col-md-3 col-6 mb-2">
                    <div class="summary-card income-card h-100">
                        <h5>รายรับทั้งหมด</h5>
                        <h3 id="total-income">฿0.00</h3>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-2">
                    <div class="summary-card expense-card h-100">
                        <h5>รายจ่ายทั้งหมด</h5>
                        <h3 id="total-expense">฿0.00</h3>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-2">
                    <div class="summary-card balance-card h-100">
                        <h5>คงเหลือ</h5>
                        <h3 id="balance">฿0.00</h3>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-2">
                    <div class="summary-card today-expense-card h-100">
                        <h5>รายจ่ายวันนี้</h5>
                        <h3 id="today-expense">฿0.00</h3>
                    </div>
                </div>
            </div>
        </section>

        <div class="row">
            <div class="col-lg-6">
                <!-- Transaction Form -->
                <section class="form-card">
                    <h4 class="mb-3">เพิ่มรายการใหม่</h4>
                    <form id="transaction-form">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="description" class="form-label">คำอธิบาย</label>
                                <input type="text" id="description" class="form-control" placeholder="เช่น ค่ากาแฟ, เงินเดือน" required>
                            </div>
                            <div class="col-md-6">
                                <label for="amount" class="form-label">จำนวนเงิน</label>
                                <input type="number" id="amount" class="form-control" placeholder="0.00" required step="0.01">
                            </div>
                            <div class="col-12">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="type" id="type-income" value="income" checked>
                                    <label class="form-check-label" for="type-income">รายรับ</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="type" id="type-expense" value="expense">
                                    <label class="form-check-label" for="type-expense">รายจ่าย</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary-custom w-100">เพิ่มรายการ</button>
                            </div>
                        </div>
                    </form>
                </section>
            </div>
            <div class="col-lg-6">
                <!-- Expense Chart -->
                <section class="chart-card">
                    <h4 class="mb-3">สัดส่วนรายจ่าย</h4>
                    <canvas id="expense-chart"></canvas>
                </section>
            </div>
        </div>

        <!-- Transaction List -->
        <section>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">ประวัติรายการ</h4>
                <div class="btn-group" role="group" id="filter-group">
                    <input type="radio" class="btn-check" name="filter-options" id="filter-all" autocomplete="off" value="all" checked>
                    <label class="btn btn-outline-primary" for="filter-all">ทั้งหมด</label>
        
                    <input type="radio" class="btn-check" name="filter-options" id="filter-today" autocomplete="off" value="today">
                    <label class="btn btn-outline-primary" for="filter-today">วันนี้</label>
                </div>
            </div>
            <div id="transaction-list">
                <!-- Transactions will be dynamically inserted here -->
            </div>
        </section>
    </div>
    
    <!-- Edit Transaction Modal -->
    <div class="modal fade" id="edit-modal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">แก้ไขรายการ</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <div class="mb-3">
                    <label for="edit-description" class="form-label">คำอธิบาย</label>
                    <input type="text" id="edit-description" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="edit-amount" class="form-label">จำนวนเงิน</label>
                    <input type="number" id="edit-amount" class="form-control" required step="0.01">
                </div>
                 <div class="mb-3">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="edit-type" id="edit-type-income" value="income">
                        <label class="form-check-label" for="edit-type-income">รายรับ</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="edit-type" id="edit-type-expense" value="expense">
                        <label class="form-check-label" for="edit-type-expense">รายจ่าย</label>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary-custom w-100">บันทึกการเปลี่ยนแปลง</button>
            </form>
          </div>
        </div>
      </div>
    </div>


    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
            getDatabase,
            ref,
            push,
            onValue,
            remove,
            update
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCa67pA2e6nFYsUBwTFBNOw6W-ldNkUouM",
            authDomain: "app-pukpik.firebaseapp.com",
            databaseURL: "https://app-pukpik-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "app-pukpik",
            storageBucket: "app-pukpik.appspot.com",
            messagingSenderId: "60353901403",
            appId: "1:60353901403:web:f28d419cd05b99d8a8e07e",
            measurementId: "G-N06T8XCLF2"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // DOM Elements
        const loadingView = document.getElementById('loading-view');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const authError = document.getElementById('auth-error');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailDisplay = document.getElementById('user-email');
        const transactionForm = document.getElementById('transaction-form');
        const transactionList = document.getElementById('transaction-list');
        const chartCanvas = document.getElementById('expense-chart');

        const totalIncomeEl = document.getElementById('total-income');
        const totalExpenseEl = document.getElementById('total-expense');
        const balanceEl = document.getElementById('balance');
        const todayExpenseEl = document.getElementById('today-expense');
        
        const filterGroup = document.getElementById('filter-group');
        const editModal = new bootstrap.Modal(document.getElementById('edit-modal'));
        const editForm = document.getElementById('edit-form');

        let currentUid = null;
        let transactionListener = null;
        let allTransactions = [];
        let expenseChartInstance = null; // To hold the chart instance

        // --- Authentication ---
        onAuthStateChanged(auth, (user) => {
            loadingView.style.display = 'none';
            if (user) {
                currentUid = user.uid;
                userEmailDisplay.textContent = user.email;
                authContainer.style.display = 'none';
                appContainer.style.display = 'block';
                listenForTransactions();
            } else {
                currentUid = null;
                appContainer.style.display = 'none';
                authContainer.style.display = 'block';
                transactionList.innerHTML = '';
                if (transactionListener) transactionListener();
            }
        });

        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            createUserWithEmailAndPassword(auth, email, password)
                .then(() => {
                    registerForm.reset();
                    authError.style.display = 'none';
                })
                .catch((error) => {
                    authError.textContent = getFirebaseErrorMessage(error);
                    authError.style.display = 'block';
                });
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            signInWithEmailAndPassword(auth, email, password)
                .then(() => {
                    loginForm.reset();
                    authError.style.display = 'none';
                })
                .catch((error) => {
                    authError.textContent = getFirebaseErrorMessage(error);
                    authError.style.display = 'block';
                });
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth).catch((error) => console.error('Logout error:', error));
        });

        function getFirebaseErrorMessage(error) {
            switch (error.code) {
                case 'auth/invalid-email': return 'รูปแบบอีเมลไม่ถูกต้อง';
                case 'auth/user-not-found':
                case 'auth/wrong-password': return 'อีเมลหรือรหัสผ่านไม่ถูกต้อง';
                case 'auth/email-already-in-use': return 'อีเมลนี้มีผู้ใช้งานแล้ว';
                case 'auth/weak-password': return 'รหัสผ่านต้องมีความยาวอย่างน้อย 6 ตัวอักษร';
                default: return 'เกิดข้อผิดพลาด โปรดลองอีกครั้ง';
            }
        }

        // --- Realtime Database (CRUD) ---
        transactionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const description = document.getElementById('description').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const type = document.querySelector('input[name="type"]:checked').value;
            if (description && amount > 0 && currentUid) {
                const transactionsRef = ref(db, 'transactions/' + currentUid);
                push(transactionsRef, {
                    description: description,
                    amount: amount,
                    type: type,
                    createdAt: new Date().toISOString()
                }).then(() => {
                    transactionForm.reset();
                }).catch(err => console.error("Error adding transaction: ", err));
            }
        });

        function listenForTransactions() {
            if (!currentUid) return;
            const transactionsRef = ref(db, 'transactions/' + currentUid);
            
            transactionListener = onValue(transactionsRef, (snapshot) => {
                let totalIncome = 0;
                let totalExpense = 0;
                let todayExpense = 0;
                const todayStr = new Date().toISOString().slice(0, 10);
                allTransactions = [];
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const transactionsArray = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                    transactionsArray.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                    allTransactions = transactionsArray;

                    allTransactions.forEach(item => {
                        if (item.type === 'income') {
                            totalIncome += item.amount;
                        } else {
                            totalExpense += item.amount;
                            if (item.createdAt.slice(0, 10) === todayStr) {
                                todayExpense += item.amount;
                            }
                        }
                    });
                }
                updateSummary(totalIncome, totalExpense, todayExpense);
                renderFilteredTransactions();
                updateExpenseChart(allTransactions); // Update chart
            });
        }
        
        function renderFilteredTransactions() {
            transactionList.innerHTML = '';
            const filterValue = document.querySelector('input[name="filter-options"]:checked').value;
            const todayStr = new Date().toISOString().slice(0, 10);
            const transactionsToRender = allTransactions.filter(item => {
                if (filterValue === 'today') return item.createdAt.slice(0, 10) === todayStr;
                return true;
            });
            if (transactionsToRender.length === 0) {
                transactionList.innerHTML = '<p class="text-center text-muted mt-3">ไม่พบรายการ</p>';
            } else {
                transactionsToRender.forEach(renderTransactionItem);
            }
        }
        
        filterGroup.addEventListener('change', renderFilteredTransactions);
        
        function renderTransactionItem(item) {
            const isIncome = item.type === 'income';
            const li = document.createElement('div');
            li.className = `transaction-list-item ${isIncome ? 'income' : 'expense'}`;
            li.innerHTML = `
                <div>
                    <h6 class="mb-0">${item.description}</h6>
                    <small class="text-muted">${new Date(item.createdAt).toLocaleString('th-TH')}</small>
                </div>
                <div class="text-end">
                    <span class="fw-bold ${isIncome ? 'text-success' : 'text-danger'}">
                        ${isIncome ? '+' : '-'}${item.amount.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}
                    </span>
                    <div>
                        <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${item.id}"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${item.id}"><i class="bi bi-trash"></i></button>
                    </div>
                </div>`;
            transactionList.appendChild(li);
        }
        
        function updateSummary(income, expense, todayExpense) {
             totalIncomeEl.textContent = income.toLocaleString('th-TH', { style: 'currency', currency: 'THB' });
             totalExpenseEl.textContent = expense.toLocaleString('th-TH', { style: 'currency', currency: 'THB' });
             balanceEl.textContent = (income - expense).toLocaleString('th-TH', { style: 'currency', currency: 'THB' });
             todayExpenseEl.textContent = todayExpense.toLocaleString('th-TH', { style: 'currency', currency: 'THB' });
        }

        function updateExpenseChart(transactions) {
            if (expenseChartInstance) {
                expenseChartInstance.destroy();
            }
            
            const expenses = transactions.filter(t => t.type === 'expense');
            const expenseData = expenses.reduce((acc, curr) => {
                const key = curr.description.trim();
                acc[key] = (acc[key] || 0) + curr.amount;
                return acc;
            }, {});

            const labels = Object.keys(expenseData);
            const data = Object.values(expenseData);
            
            if (labels.length === 0) {
                // If no expense data, don't draw chart
                chartCanvas.style.display = 'none';
                return;
            }
            chartCanvas.style.display = 'block';

            const ctx = chartCanvas.getContext('2d');
            expenseChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'รายจ่าย',
                        data: data,
                        backgroundColor: [
                            '#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40',
                            '#e85e88', '#5e9ee8', '#e8c15e', '#66d3d3', '#ad85ff', '#ffb266'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        transactionList.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const id = target.dataset.id;
            if (target.classList.contains('delete-btn')) {
                if (confirm('คุณแน่ใจว่าต้องการลบรายการนี้?')) {
                    remove(ref(db, `transactions/${currentUid}/${id}`)).catch(err => console.error("Delete failed: ", err));
                }
            } else if (target.classList.contains('edit-btn')) {
                const itemData = allTransactions.find(t => t.id === id);
                if(itemData) {
                    document.getElementById('edit-id').value = id;
                    document.getElementById('edit-description').value = itemData.description;
                    document.getElementById('edit-amount').value = itemData.amount;
                    document.querySelector(`input[name="edit-type"][value="${itemData.type}"]`).checked = true;
                    editModal.show();
                }
            }
        });
        
        editForm.addEventListener('submit', (e) => {
             e.preventDefault();
             const id = document.getElementById('edit-id').value;
             const description = document.getElementById('edit-description').value;
             const amount = parseFloat(document.getElementById('edit-amount').value);
             const type = document.querySelector('input[name="edit-type"]:checked').value;
             if (id && description && amount > 0) {
                 update(ref(db, `transactions/${currentUid}/${id}`), {
                     description, amount, type
                 }).then(() => {
                     editModal.hide();
                 }).catch(err => console.error("Update failed: ", err));
             }
        });
    </script>
</body>
</html>

